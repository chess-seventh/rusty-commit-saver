name: ðŸ“š Stage 4 - Documentation
on:
  push:
    branches: ["master"]
permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: "pages"
  cancel-in-progress: false
env:
  CARGO_TERM_COLOR: always
jobs:
  build-docs:
    name: ðŸ“š Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # CRITICAL: Pull latest changes after release commit
          ref: master
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ“š Generate documentation
        run: |
          cargo doc --no-deps --document-private-items

          touch target/doc/.nojekyll

          cat > target/doc/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=rusty_commit_saver">
              <title>Rusty Commit Saver - Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      justify-content: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  h1 { font-size: 3em; margin: 0; }
                  p { font-size: 1.2em; opacity: 0.9; }
                  a { color: #fff; text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>ðŸ“š Rusty Commit Saver</h1>
              <p>Redirecting to documentation...</p>
              <p>If not redirected, <a href="rusty_commit_saver">click here</a></p>
          </body>
          </html>
          EOF
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./target/doc
  deploy-docs:
    name: ðŸš€ Deploy Documentation
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  sync-wiki:
    name: ðŸ“– Sync Wiki
    runs-on: ubuntu-latest
    needs: deploy-docs
    steps:
      - uses: actions/checkout@v4
        with:
          # CRITICAL: Pull latest changes including release updates
          ref: master
      - name: ðŸ“– Update Wiki
        run: |
          git clone https://github.com/${{ github.repository }}.wiki.git wiki || exit 0

          cat > wiki/Home.md << 'EOF'
          > ðŸ“š **[View Full API Documentation](https://chess-seventh.github.io/rusty-commit-saver/rusty_commit_saver/)**

          ---

          EOF
          cat README.md >> wiki/Home.md

          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Home.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: sync README with API docs link"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git || exit 0
