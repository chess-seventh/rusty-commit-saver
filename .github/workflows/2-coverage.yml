name: Stage 2 - ğŸ“Š Coverage Analysis
on:
  workflow_run:
    workflows: ["Stage 1 - ğŸ” Quality Checks"]
    types: [completed]
  pull_request:
    branches: ["master"]
  push:
    branches: ["master"]
env:
  CARGO_TERM_COLOR: always
jobs:
  coverage:
    name: ğŸ“š Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - name: ğŸ› ï¸ Install tools
        uses: taiki-e/install-action@v2
        with:
          tool: nextest,cargo-llvm-cov
      - name: ğŸ“š Collect coverage
        run: |
          cargo llvm-cov --no-report nextest --no-fail-fast
          cargo llvm-cov report --lcov --output-path lcov.info
      - name: ğŸ’­ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: chess-seventh/rusty-commit-saver
          flags: coverage
          name: Code Coverage
