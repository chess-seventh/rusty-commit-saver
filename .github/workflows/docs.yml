name: ðŸ“š Documentation
on:
  push:
    branches: [master]
permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: "pages"
  cancel-in-progress: false
env:
  CARGO_TERM_COLOR: always
jobs:
  # Generate Rustdoc
  build:
    name: ðŸ“š Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ“š Generate documentation
        run: |
          cargo doc --no-deps --document-private-items

          # Disable Jekyll
          touch target/doc/.nojekyll

          # Create landing page
          cat > target/doc/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=rusty_commit_saver">
              <title>Rusty Commit Saver - Documentation</title>
          </head>
          <body>
              <h1>ðŸ“š Rusty Commit Saver Documentation</h1>
              <p>Redirecting to <a href="rusty_commit_saver">main documentation</a>...</p>
          </body>
          </html>
          EOF
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./target/doc
  # Deploy to GitHub Pages
  deploy:
    name: ðŸš€ Deploy to Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  # Sync README to Wiki
  wiki:
    name: ðŸ“– Sync Wiki
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“– Update Wiki
        run: |
          git clone https://github.com/${{ github.repository }}.wiki.git wiki || exit 0

          cat > wiki/Home.md << 'EOF'
          > ðŸ“š **[View Full API Documentation](https://chess-seventh.github.io/rusty-commit-saver/rusty_commit_saver/)**

          ---

          EOF
          cat README.md >> wiki/Home.md

          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Home.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: sync README"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git || exit 0
