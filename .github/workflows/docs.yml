name: ðŸ“š Documentation
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
env:
  CARGO_TERM_COLOR: always
jobs:
  # Generate Rustdoc and deploy to GitHub Pages
  rustdoc:
    name: ðŸ“š Generate & Deploy Rustdoc
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ“š Generate comprehensive documentation
        run: |
          # Generate docs for all items (public + private)
          cargo doc --no-deps --document-private-items

          # Create index.html that redirects to main crate docs
          echo '<meta http-equiv="refresh" content="0; url=rusty_commit_saver">' > target/doc/index.html

          # Optional: Add a custom landing page
          cat > target/doc/index_temp.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=rusty_commit_saver">
              <title>Rusty Commit Saver - Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      justify-content: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  h1 { font-size: 3em; margin: 0; }
                  p { font-size: 1.2em; opacity: 0.9; }
                  a { color: #fff; text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>ðŸ“š Rusty Commit Saver</h1>
              <p>Redirecting to documentation...</p>
              <p>If not redirected, <a href="rusty_commit_saver">click here</a></p>
          </body>
          </html>
          EOF

          # Use custom landing page
          mv target/doc/index_temp.html target/doc/index.html
      - name: ðŸ“¤ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          # Deploy to root, not a subdirectory
          cname: false
  # Sync README to Wiki (optional - can be removed if you only want rustdoc)
  wiki:
    name: ðŸ“– Sync Wiki
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“– Clone and update Wiki
        run: |
          # Clone wiki repository
          git clone https://github.com/${{ github.repository }}.wiki.git wiki || exit 0

          # Copy README to Wiki home
          cp README.md wiki/Home.md

          # Add link to API docs at top of wiki
          cat > wiki/Home.md << 'EOF'
          > ðŸ“š **[View Full API Documentation](https://chess-seventh.github.io/rusty-commit-saver/rusty_commit_saver/)**

          ---

          EOF
          cat README.md >> wiki/Home.md

          # Commit and push
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Home.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: sync README to Wiki with API docs link"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git || exit 0
