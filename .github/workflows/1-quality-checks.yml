name: Stage 1 - üîç Quality Checks
on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
env:
  CARGO_TERM_COLOR: always
jobs:
  build:
    name: üõ†Ô∏è Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: üõ†Ô∏è Build
        run: cargo build --verbose
  unittest:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: üõ†Ô∏è Install nextest and cargo2junit
        uses: taiki-e/install-action@v2
        with:
          tool: nextest,cargo2junit
      - uses: Swatinem/rust-cache@v2
      - name: üß™ Run tests with nextest (human readable output)
        run: cargo nextest run --no-fail-fast --profile ci
        env:
          CARGO_TERM_COLOR: always
      - name: üìä Generate JUnit XML from cargo test
        if: always()
        run: |
          cargo test --no-fail-fast --lib --bins -- --format json -Z unstable-options --report-time 2>&1 | \
          cargo2junit > junit.xml || true
        env:
          RUSTC_BOOTSTRAP: 1
      - name: üìä Upload test results to Codecov
        if: always() && hashFiles('junit.xml') != ''
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: junit.xml
          flags: unittests
          name: Unit Tests
          report_type: test_results
  clippy:
    name: ‚úÇÔ∏è Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: ‚úÇÔ∏è Clippy
        run: cargo clippy --all-targets -- -W clippy::pedantic -A clippy::must_use_candidate
