name: ðŸš€ CI/CD Pipeline
on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
permissions:
  contents: write
  pages: write
  id-token: write
concurrency:
  group: "pages"
  cancel-in-progress: false
env:
  CARGO_TERM_COLOR: always
jobs:
  # ============================================================================
  # STAGE 1: Quality Checks (run in parallel)
  # ============================================================================
  build:
    name: ðŸ› ï¸ Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ› ï¸ Build
        run: cargo build --verbose
  unittest:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ› ï¸ Install nextest and cargo2junit
        uses: taiki-e/install-action@v2
        with:
          tool: nextest,cargo2junit
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ§ª Run tests with nextest (human readable output)
        run: cargo nextest run --no-fail-fast --profile ci
        env:
          CARGO_TERM_COLOR: always
      - name: ðŸ“Š Generate JUnit XML from cargo test
        if: always()
        run: |
          cargo test --no-fail-fast --lib --bins -- --format json -Z unstable-options --report-time 2>&1 | \
          cargo2junit > junit.xml || true
        env:
          RUSTC_BOOTSTRAP: 1
      - name: ðŸ“Š Upload test results to Codecov
        if: always() && hashFiles('junit.xml') != ''
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: junit.xml
          flags: unittests
          name: Unit Tests
          report_type: test_results
  clippy:
    name: âœ‚ï¸ Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: âœ‚ï¸ Clippy
        run: cargo clippy --all-targets -- -W clippy::pedantic -A clippy::must_use_candidate
  # Temporary remove as there's an issue with shear needing Rust 1.91 - not available yet.
  # Moved this check in the pre-commit hook.
  # cleanup-deps:
  #   name: ðŸ§¹ Dependency Check
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dtolnay/rust-toolchain@stable
  #     - uses: Swatinem/rust-cache@v2
  #     - name: ðŸ› ï¸ Install cargo-shear
  #       run: cargo install cargo-shear@1.8.0
  #     - name: ðŸ§¹ Check unused dependencies
  #       run: cargo shear
  # ============================================================================
  # STAGE 2: Coverage (optional, allowed to fail)
  # ============================================================================
  coverage:
    name: ðŸ“š Coverage
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ› ï¸ Install tools
        uses: taiki-e/install-action@v2
        with:
          tool: nextest,cargo-llvm-cov
      - name: ðŸ“š Collect coverage
        run: |
          cargo llvm-cov --no-report nextest --no-fail-fast
          cargo llvm-cov report --lcov --output-path lcov.info
      - name: ðŸ’­ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: chess-seventh/rusty-commit-saver
          flags: coverage
          name: Code Coverage
  # ============================================================================
  # STAGE 3: Release (only on push to master after ALL checks pass)
  # ============================================================================
  release:
    name: ðŸŽ¯ Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: [build, unittest, clippy]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - name: ðŸ› ï¸ Install cargo-edit
        run: cargo install cargo-edit
      - name: ðŸŽ¨ Conventional Changelog
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          git-user-name: "chess-seventh"
          git-user-email: "chess7th@pm.me"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          git-message: "ci: version bump"
          output-file: "CHANGELOG.md"
          release-count: "0"
          skip-version-file: "false"
          skip-commit: "false"
          skip-on-empty: "true"
          version-file: "Cargo.toml"
          version-path: "package.version"
          create-summary: "true"
      - name: ðŸ› ï¸ Update Cargo.toml version
        if: steps.changelog.outputs.skipped == 'false'
        run: |
          cargo set-version ${{ steps.changelog.outputs.version }}
          cargo build --verbose
      - name: ðŸ› ï¸ Update flake.nix version to match Cargo.toml
        if: steps.changelog.outputs.skipped == 'false'
        run: |
          VERSION="${{ steps.changelog.outputs.version }}"
          # Update version in flake.nix - matches pattern: version = "X.Y.Z";
          sed -i "s/version = \"[0-9]*\.[0-9]*\.[0-9]*\";/version = \"${VERSION}\";/" flake.nix
          # Verify the update
          grep "version = " flake.nix | head -1
      - name: ðŸ› ï¸ Update lockfile
        if: steps.changelog.outputs.skipped == 'false'
        run: cargo update
      - name: ðŸ› ï¸ Commit Cargo.lock, Cargo.toml, and flake.nix
        if: steps.changelog.outputs.skipped == 'false'
        run: |
          git config user.name "chess-seventh"
          git config user.email "chess7th@pm.me"
          git add Cargo.lock Cargo.toml flake.nix
          git commit -m "chore: update Cargo.lock, Cargo.toml, and flake.nix [skip ci]"
          git push
      - name: âœ¨ Create Release
        if: steps.changelog.outputs.skipped == 'false'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.changelog.outputs.tag }}
          name: ${{ steps.changelog.outputs.tag }}
          body: ${{ steps.changelog.outputs.clean_changelog }}
          token: ${{ secrets.GITHUB_TOKEN }}
  # ============================================================================
  # STAGE 4: Documentation (only on push to master after release)
  # ============================================================================
  build-docs:
    name: ðŸ“š Build Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: release
    steps:
      - uses: actions/checkout@v4
        with:
          # CRITICAL: Pull latest changes after release commit
          ref: master
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: ðŸ“š Generate documentation
        run: |
          cargo doc --no-deps --document-private-items

          touch target/doc/.nojekyll

          cat > target/doc/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=rusty_commit_saver">
              <title>Rusty Commit Saver - Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      justify-content: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  h1 { font-size: 3em; margin: 0; }
                  p { font-size: 1.2em; opacity: 0.9; }
                  a { color: #fff; text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>ðŸ“š Rusty Commit Saver</h1>
              <p>Redirecting to documentation...</p>
              <p>If not redirected, <a href="rusty_commit_saver">click here</a></p>
          </body>
          </html>
          EOF
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./target/doc
  deploy-docs:
    name: ðŸš€ Deploy Documentation
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: build-docs
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  sync-wiki:
    name: ðŸ“– Sync Wiki
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: deploy-docs
    steps:
      - uses: actions/checkout@v4
        with:
          # CRITICAL: Pull latest changes including release updates
          ref: master
      - name: ðŸ“– Update Wiki
        run: |
          git clone https://github.com/${{ github.repository }}.wiki.git wiki || exit 0

          cat > wiki/Home.md << 'EOF'
          > ðŸ“š **[View Full API Documentation](https://chess-seventh.github.io/rusty-commit-saver/rusty_commit_saver/)**

          ---

          EOF
          cat README.md >> wiki/Home.md

          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Home.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: sync README with API docs link"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git || exit 0
